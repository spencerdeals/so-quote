<script>
// ==== CONFIG & HEALTH ====
let BACKEND_URL = localStorage.getItem('instantImportBackend') || '';
function setBackend(u){ BACKEND_URL=(u||'').trim(); localStorage.setItem('instantImportBackend', BACKEND_URL); checkHealth(); }
async function checkHealth(){
  const badge = document.getElementById('healthBadge');
  try{
    if(!BACKEND_URL){ badge.innerText='Frontend only'; return; }
    const r = await fetch(BACKEND_URL.replace(/\/$/,'') + '/health', { cache:'no-store' });
    const j = await r.json();
    badge.innerText = 'Backend ' + (j?.version || 'ok');
  }catch{ badge.innerText='Backend unreachable'; }
}

// ==== MODEL ====
let items=[]; let vendorFees={};
const ENTRY_FEE_PER_ITEM=9, WHARFAGE_PER_ITEM=0;

// ==== HELPERS ====
function parseLinks(t){ return Array.from(new Set((t||'').split(/\n|\s+/).map(s=>s.trim()).filter(s=>/^https?:\/\//.test(s)))); }
function hostname(u){ try{ const h=new URL(u).hostname.toLowerCase(); return h.replace(/^www\./,''); }catch{ return 'unknown'; } }
function guessNameFromUrl(u){ try{ const p=new URL(u).pathname.split('/').filter(Boolean); const last=p[p.length-1]||u; return decodeURIComponent(last.replace(/[-_]/g,' ')).slice(0,120); }catch{ return u; } }
function money(n){ return (n||0).toLocaleString(undefined,{style:'currency',currency:'USD'}); }

// ==== STEPPER ====
const stepper=document.getElementById('stepper').children;
function goStep(n){ for(let i=0;i<3;i++){ stepper[i].classList.remove('step-active'); document.getElementById(`panel-${i+1}`).classList.add('hidden'); } stepper[n-1].classList.add('step-active'); document.getElementById(`panel-${n}`).classList.remove('hidden'); }

// ==== STEP 1: RENDER CURRENT ITEMS (title + price) ====
function refreshLinkList(){
  const ul=document.getElementById('linkList'); ul.innerHTML='';
  items.forEach((it,idx)=>{
    const title = it.title && it.title!=='Fetching name…' ? it.title : guessNameFromUrl(it.url);
    const li=document.createElement('li');
    li.className='flex items-center gap-2';
    li.innerHTML = `<span class="flex-1 break-all">${title}</span>
      <input type="number" step="0.01" min="0" placeholder="Price" value="${Number.isFinite(it.unitPrice)?it.unitPrice:''}" data-idx="${idx}" class="num w-28 border rounded px-2 py-1"/>`;
    ul.appendChild(li);
  });
  ul.querySelectorAll('input[data-idx]').forEach(inp=>{
    inp.addEventListener('input',e=>{
      const i=+e.target.dataset.idx, v=e.target.value;
      items[i].unitPrice = v===''? undefined : (parseFloat(v)||0);
    });
  });
}

function ensureVendors(){
  const vendors=[...new Set(items.map(it=>it.vendor))];
  const wrap=document.getElementById('vendorFeesWrap');
  const list=document.getElementById('vendorFees');
  if(!vendors.length){ wrap.classList.add('hidden'); list.innerHTML=''; return; }
  wrap.classList.remove('hidden'); list.innerHTML='';
  vendors.forEach(v=>{
    if(!vendorFees[v]) vendorFees[v]={delivery:0};
    const val=vendorFees[v].delivery??0;
    const row=document.createElement('div');
    row.className='flex items-center gap-2 border rounded-xl p-2 bg-white';
    row.innerHTML=`<div class="font-medium flex-1">${v}</div><label class="text-sm">Delivery fee</label><input type="number" min="0" step="0.01" value="${val}" data-vendor="${v}" class="num w-28 border rounded px-2 py-1" />`;
    list.appendChild(row);
  });
}

function validateStep1(){
  const ok = items.length && document.getElementById('variantCheckbox').checked;
  const btn = document.getElementById('toStep2');
  btn.disabled = !ok; btn.classList.toggle('disabled', !ok);
}

// ==== ENRICH (BATCH) WITH TIMEOUT + URL-NAME FALLBACK ====
async function enrichBatch(urls){
  if(!urls.length) return;
  // If no backend configured, fallback to URL-based names immediately
  if(!BACKEND_URL){
    urls.forEach(u=>{ const it=items.find(x=>x.url===u);
      if(it && (!it.title || it.title==='Fetching name…')) it.title = guessNameFromUrl(u);
    });
    refreshLinkList(); return;
  }
  const controller = new AbortController();
  const t = setTimeout(()=>controller.abort(), 8000);
  try{
    const r = await fetch(BACKEND_URL.replace(/\/$/,'')+'/enrich', {
      method:'POST', headers:{'Content-Type':'application/json'}, signal: controller.signal,
      body: JSON.stringify({ items: urls.map(u=>({ url:u })) })
    });
    if(r.ok){
      const j = await r.json();
      const map = new Map((j.items||[]).map(en=>[en.url, en]));
      items = items.map(it=>{
        const en = map.get(it.url);
        if(!en) return it;
        return {
          ...it,
          title: en.title || it.title || guessNameFromUrl(it.url),
          unitPrice: Number.isFinite(en.unitPrice) ? en.unitPrice : it.unitPrice
        };
      });
      refreshLinkList();
    }
  }catch{/* ignore; fallback below */}
  finally{ clearTimeout(t); }
  // Final fallback
  urls.forEach(u=>{ const it=items.find(x=>x.url===u);
    if(it && (!it.title || it.title==='Fetching name…')) it.title = guessNameFromUrl(u);
  });
  refreshLinkList();
}

// ==== STEP 1 EVENTS ====
document.getElementById('addLinkBtn').onclick = ()=>{
  const input=document.getElementById('linkInputSingle');
  const urls=parseLinks(input.value);
  if(!urls.length) return;
  urls.forEach(u=>{ items.push({ url:u, title:'Fetching name…', qty:1, unitPrice:undefined, notes:'', vendor:hostname(u) }); });
  input.value='';
  refreshLinkList(); ensureVendors(); validateStep1();
  enrichBatch(urls);
};
document.getElementById('variantCheckbox').onchange = validateStep1;

// ==== STEP 2 RENDER (title + price/fees, unchanged math) ====
function renderItemsTable(){
  const tb=document.getElementById('itemsBody'); tb.innerHTML='';
  items.forEach((it,i)=>{
    const missing = !(Number.isFinite(it.unitPrice) && it.unitPrice>0);
    const wharf = WHARFAGE_PER_ITEM * it.qty;
    const entry = ENTRY_FEE_PER_ITEM * it.qty;
    const title = it.title || guessNameFromUrl(it.url);
    tb.innerHTML += `
      <tr class="align-top">
        <td class="py-2 pr-3">
          <div class="font-medium">${title}</div>
          <a class="text-[var(--sdl-green)] underline text-xs" href="${it.url}" target="_blank">${it.url}</a>
          ${missing?'<div class="text-xs text-rose-600">Needs price</div>':''}
          <div class="text-[10px] text-gray-500">Vendor: ${it.vendor}</div>
        </td>
        <td class="py-2 pr-3"><input type="number" min="1" value="${it.qty}" data-i="${i}" class="qty num w-20 border rounded px-2 py-1"></td>
        <td class="py-2 pr-3"><input type="number" step="0.01" min="0" value="${Number.isFinite(it.unitPrice)?it.unitPrice:''}" data-i="${i}" class="price num w-32 border rounded px-2 py-1" placeholder="enter price"></td>
        <td class="py-2 pr-3">${wharf.toFixed(2)}</td>
        <td class="py-2 pr-3">${entry.toFixed(2)}</td>
        <td class="py-2 pr-3"><input type="text" value="${it.notes||''}" data-i="${i}" class="note w-full border rounded px-2 py-1" placeholder="variant, color, size"></td>
        <td class="py-2 pr-1"><button class="del text-red-600" data-i="${i}">✕</button></td>
      </tr>`;
  });
  tb.querySelectorAll('.qty').forEach(e=>e.oninput=ev=>{ items[e.dataset.i].qty=Math.max(1,parseInt(ev.target.value||1)); renderTotalsIfVisible(); });
  tb.querySelectorAll('.price').forEach(e=>e.oninput=ev=>{ items[e.dataset.i].unitPrice = ev.target.value===''? undefined : (parseFloat(ev.target.value)||0); validateStep2(); renderTotalsIfVisible(); });
  tb.querySelectorAll('.note').forEach(e=>e.oninput=ev=>{ items[e.dataset.i].notes=ev.target.value; });
  tb.querySelectorAll('.del').forEach(e=>e.onclick=()=>{ items.splice(e.dataset.i,1); renderItemsTable(); validateStep2(); ensureVendors(); renderTotalsIfVisible(); });
  validateStep2();
}
function validateStep2(){ const b=document.getElementById('toStep3'); b.disabled = !items.every(it=>Number.isFinite(it.unitPrice)&&it.unitPrice>0); b.classList.toggle('disabled', b.disabled); }
function totals(){ const itemsTotal = items.reduce((s,it)=>s+((Number.isFinite(it.unitPrice)?it.unitPrice:0)*it.qty),0); const wharf=items.length*WHARFAGE_PER_ITEM; const entry=items.length*ENTRY_FEE_PER_ITEM; const delivery=Object.values(vendorFees).reduce((s,v)=>s+(v?.delivery||0),0); const grand=itemsTotal+wharf+entry+delivery; return { itemsTotal, wharf, entry, delivery, grand }; }
function moneyTotals(){ const t=totals(); return { items:money(t.itemsTotal), wharf:money(t.wharf), entry:money(t.entry), delivery:money(t.delivery), grand:money(t.grand) }; }
function renderVendorSummary(){ const vs=document.getElementById('vendorSummary'); if(!vs) return; const vendors=[...new Set(items.map(it=>it.vendor))]; vs.innerHTML=''; vendors.forEach(v=>{ const n=vendorFees[v]?.delivery||0; const div=document.createElement('div'); div.className='flex items-center gap-2'; div.innerHTML=`<div class="flex-1">${v}</div><input type="number" min="0" step="0.01" value="${n}" data-vendor="${v}" class="num w-28 border rounded px-2 py-1" />`; vs.appendChild(div); }); vs.querySelectorAll('input[data-vendor]').forEach(inp=>inp.addEventListener('input',e=>{ const v=e.target.getAttribute('data-vendor'); const n=parseFloat(e.target.value||'0')||0; vendorFees[v]={delivery:n}; renderTotalsIfVisible(); })); }
function renderSummary(){ const tb=document.getElementById('summaryBody'); tb.innerHTML=''; items.forEach(it=>{ const u=Number.isFinite(it.unitPrice)?it.unitPrice:0; const wh=WHARFAGE_PER_ITEM; const en=ENTRY_FEE_PER_ITEM; const rowTotal=u*it.qty+wh+en; const title=it.title||guessNameFromUrl(it.url); tb.innerHTML += `<tr><td class="py-1 pr-2">${title}</td><td class="py-1 pr-2">${it.qty}</td><td class="py-1 pr-2">${money(u)}</td><td class="py-1 pr-2">${money(wh)}</td><td class="py-1 pr-2">${money(en)}</td><td class="py-1 pr-2">${money(rowTotal)}</td></tr>`; }); const t=moneyTotals(); document.getElementById('sumItems').innerText=t.items; document.getElementById('sumDelivery').innerText=t.delivery; document.getElementById('sumWharf').innerText=t.wharf; document.getElementById('sumEntry').innerText=t.entry; document.getElementById('sumGrand').innerText=t.grand; const sv=document.getElementById('summaryVendors'); sv.innerHTML=''; Object.keys(vendorFees).forEach(v=>{ const n=vendorFees[v]?.delivery||0; const div=document.createElement('div'); div.className='flex justify-between text-sm'; div.innerHTML=`<span>${v}</span><span>${money(n)}</span>`; sv.appendChild(div); }); }
function renderTotalsIfVisible(){ if(!document.getElementById('panel-3').classList.contains('hidden')) renderSummary(); }

// ==== NAV ====
document.getElementById('toStep2').onclick = ()=>{ renderItemsTable(); renderVendorSummary(); goStep(2); };
document.getElementById('backTo1').onclick = ()=> goStep(1);
document.getElementById('toStep3').onclick = ()=>{ renderSummary(); goStep(3); };

// ==== BOOT ====
checkHealth();
goStep(1);
</script>
