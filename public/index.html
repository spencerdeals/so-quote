<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Special Order – Instant Quote</title>
  <style>
    :root { --text:#0f2732; --muted:#607b92; --bg:transparent; --accent:#2e7d32; --accent2:#0b5ed7; --danger:#c62828; --card:#fff; --line:#e5e8eb; }
    html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font:16px/1.5 -apple-system,system-ui,Segoe UI,Roboto,Arial,sans-serif}
    .wrap{max-width:980px;margin:0 auto;padding:16px 20px}
    h1{font-size:28px;margin:16px 0 24px;font-weight:700}
    .card{background:var(--card);border:1px solid var(--line);border-radius:10px;padding:16px}
    .row{display:grid;grid-template-columns:1fr 1fr 1fr 1fr 100px;gap:10px;align-items:end}
    .row + .row{margin-top:12px}
    label{font-weight:600;font-size:13px;color:var(--muted);display:block;margin-bottom:6px}
    input,select,textarea{width:100%;padding:10px;border:1px solid #d0d7de;border-radius:6px;font-size:14px;box-sizing:border-box}
    .btn{display:inline-flex;justify-content:center;align-items:center;background:var(--accent);color:#fff;border-radius:8px;padding:12px 18px;border:none;cursor:pointer;font-weight:700}
    .btn.secondary{background:var(--accent2)} .btn.ghost{background:#fff;color:var(--accent2);border:1px solid var(--accent2)} .btn.danger{background:var(--danger)} .btn:disabled{opacity:.6;cursor:not-allowed}
    .actions{display:flex;gap:10px;justify-content:flex-end;margin-top:16px}
    .items{display:grid;gap:12px}
    .kicker{margin-top:10px;font-size:13px;color:var(--muted)}
    .results{margin-top:20px;padding:16px;border:1px dashed var(--line);border-radius:10px;background:#fafbfc}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{padding:8px 10px;border-bottom:1px solid var(--line);text-align:left} th{font-size:13px;color:var(--muted)}
    .right{text-align:right} .total{font-weight:700}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;background:#eef6ff;color:#0b5ed7}
  </style>
</head>
<body>
  <main class="wrap">
    <h1>Special Order – Instant Quote</h1>

    <div class="card">
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:16px;">
        <div><label>Your name</label><input id="custName" type="text" placeholder="Jane Doe" /></div>
        <div><label>Email</label><input id="custEmail" type="email" placeholder="jane@example.com" /></div>
      </div>

      <div class="items" id="items"></div>

      <div class="actions">
        <button class="btn ghost" id="addItemBtn" type="button">+ Add another item</button>
        <button class="btn" id="quoteBtn" type="button">Get Quote</button>
      </div>

      <div class="kicker">Destination assumed: <span class="pill">07201 (Elizabeth, NJ)</span></div>

      <div class="results" id="results" style="display:none;"></div>
    </div>
  </main>

  <script>
    const itemsEl = document.getElementById("items");
    const addItemBtn = document.getElementById("addItemBtn");
    const quoteBtn = document.getElementById("quoteBtn");
    const resultsEl = document.getElementById("results");

    function itemRow(d = {}) {
      const wrap = document.createElement("div");
      wrap.className = "row";
      wrap.innerHTML = `
        <div>
          <label>Vendor</label>
          <select class="i-vendor">
            <option${(d.vendor||"").toLowerCase().includes("amazon")?" selected":""}>Amazon</option>
            <option${(d.vendor||"").toLowerCase().includes("wayfair")?" selected":""}>Wayfair</option>
            <option${(d.vendor||"") && !/(amazon|wayfair)/i.test(d.vendor)?" selected":""}>Other</option>
          </select>
        </div>
        <div>
          <label>Item URL</label>
          <input class="i-url" type="url" placeholder="https://..." value="${d.url||""}" />
        </div>
        <div>
          <label>First cost (USD)</label>
          <input class="i-first" type="number" step="0.01" min="0" placeholder="0.00" value="${d.firstCost||""}" />
        </div>
        <div>
          <label>Size (ft³)</label>
          <input class="i-ft3" type="number" step="0.01" min="0" placeholder="e.g. 2.5" value="${d.ft3||""}" />
        </div>
        <div>
          <label>Qty</label>
          <input class="i-qty" type="number" step="1" min="1" value="${d.qty||1}" />
        </div>`;
      return wrap;
    }
    function ensureAtLeastOneRow(){ if(!itemsEl.children.length) itemsEl.appendChild(itemRow()); }
    addItemBtn.addEventListener("click",()=>itemsEl.appendChild(itemRow()));

    quoteBtn.addEventListener("click", async () => {
      const rows = Array.from(itemsEl.querySelectorAll(".row"));
      if (!rows.length) itemsEl.appendChild(itemRow());
      const items = rows.map(r=>({
        vendor: r.querySelector(".i-vendor")?.value||"",
        url: r.querySelector(".i-url")?.value||"",
        firstCost: r.querySelector(".i-first")?.value||"0",
        ft3: r.querySelector(".i-ft3")?.value||"0",
        qty: r.querySelector(".i-qty")?.value||"1",
      }));
      quoteBtn.disabled = true; quoteBtn.textContent = "Calculating…";
      try{
        const res = await fetch("/api/quote",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({items})});
        const data = await res.json();
        renderResults(data);
      }catch(e){
        console.error(e);
        resultsEl.style.display="block";
        resultsEl.innerHTML=`<div style="color:#c62828">Sorry, something went wrong calculating the quote.</div>`;
      }finally{
        quoteBtn.disabled=false; quoteBtn.textContent="Get Quote";
      }
    });

    function money(n){ return "$" + (Number(n||0)).toFixed(2); }
    function pct(n){ return (Number(n)*100).toFixed(2)+"%"; }

    function renderResults(data){
      if(!data || !data.totals){ resultsEl.style.display="block"; resultsEl.innerHTML=`<div style="color:#c62828">No result.</div>`; return; }
      const { totals, lines, destinationZip } = data;
      const rows = lines.map(l=>`
        <tr>
          <td>${l.i}</td><td>${l.vendor||""}</td><td>${l.qty}</td>
          <td class="right">${money(l.firstCost)}</td><td class="right">${l.ft3}</td>
          <td class="right">${money(l.tax)}</td><td class="right">${money(l.duty)}</td>
          <td class="right">${money(l.wharfage)}</td><td class="right">${money(l.freight)}</td>
          <td class="right">${money(l.fixedFff)}</td><td class="right">${money(l.cardShare)}</td>
          <td class="right total">${money(l.lineLanded)}</td>
        </tr>`).join("");
      resultsEl.style.display="block";
      resultsEl.innerHTML = `
        <div><strong>Destination:</strong> ${destinationZip||"07201"}</div>
        <table>
          <thead><tr>
            <th>#</th><th>Vendor</th><th>Qty</th>
            <th class="right">First cost</th><th class="right">ft³ / unit</th>
            <th class="right">Sales tax</th><th class="right">Duty</th>
            <th class="right">Wharfage</th><th class="right">Freight</th>
            <th class="right">Fixed FFF</th><th class="right">Card fee (share)</th>
            <th class="right">Line landed</th>
          </tr></thead>
          <tbody>${rows}</tbody>
        </table>
        <table><tbody>
          <tr><td>Total ft³</td><td class="right">${totals.totalFt3.toFixed(2)}</td></tr>
          <tr><td>Subtotal (before card)</td><td class="right">${money(totals.subtotalBeforeCard)}</td></tr>
          <tr><td>Card fee (3.75%)</td><td class="right">${money(totals.cardFee)}</td></tr>
          <tr><td class="total">Total landed</td><td class="right total">${money(totals.totalLanded)}</td></tr>
          <tr><td>Margin applied</td><td class="right">${pct(totals.marginRate)}</td></tr>
          <tr><td class="total">Suggested retail</td><td class="right total">${money(totals.suggestedRetail)}</td></tr>
        </tbody></table>`;
    }
    ensureAtLeastOneRow();
  </script>
</body>
</html>
