<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Instant Import V5 — Bulk Paste → Line Items</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root { --sdl:#2e7d32; --sdl-dark:#1b5e20; --sdl-soft:#e8f5e9; }
    .btn { padding: 0.5rem 1rem; border-radius: 0.375rem; }
    .btn-primary { background: var(--sdl); color: #fff; }
    .btn-primary:hover { background: var(--sdl-dark); }
    .btn-ghost { border: 1px solid #e5e7eb; background: #fff; }
    .num { appearance: textfield; }
    .num::-webkit-inner-spin-button, .num::-webkit-outer-spin-button { appearance: none; }
  </style>
</head>
<body class="p-6 font-sans bg-gray-50">
  <header class="mb-4">
    <h1 class="text-2xl font-bold">Instant Import V5 — Bulk Paste → Line Items</h1>
    <p class="text-sm text-gray-700">
      Paste <strong>links only</strong>, one per line. We’ll split them into items and group by <strong>vendor</strong>.
      <span class="inline-block mt-1 p-1 px-2 bg-[var(--sdl-soft)] border rounded">
        Note: Enter prices manually. Use <em>Get Price</em> to open the product page.
      </span>
    </p>
  </header>

  <section class="mb-4">
    <label for="links" class="block text-sm font-medium mb-1">Product links (one per line)</label>
    <textarea id="links" class="w-full border rounded p-3 min-h-[140px]" placeholder="https://www.amazon.com/...
https://www.wayfair.com/...
https://www.target.com/...
..."></textarea>
    <div class="mt-2 flex items-center gap-2">
      <button id="process" class="btn btn-primary">Create line items</button>
      <button id="clearAll" class="btn btn-ghost">Clear All</button>
    </div>
  </section>

  <section id="groupsSection" class="hidden">
    <div class="flex items-center justify-between mb-2">
      <h2 class="text-lg font-semibold">Grouped by Vendor</h2>
      <div id="totalsBadge" class="text-sm text-gray-700"></div>
    </div>
    <div id="groups" class="space-y-6"></div>
    <div class="mt-4 p-3 bg-[var(--sdl-soft)] border rounded flex items-center justify-between">
      <strong>Grand Total (items + vendor delivery fees):</strong>
      <span id="grandTotal">$0.00</span>
    </div>
  </section>

  <script>
    // ====== CONFIG ======
    // If backend is a different domain, set it here, e.g.:
    // const API_BASE = "https://your-backend.example.com";
    const API_BASE = "https://so-quote.fly.dev";   // replace with your backend URL

    // ====== Helpers ======
    function parseLines(text){
      return (text||'').split(/\r?\n+/).map(line => line.trim()).filter(Boolean);
    }
    function normalizeHost(url){
      try{ return new URL(url).hostname.replace(/^www\./,''); }catch{return 'other';}
    }
    function vendorLabel(host){
      const map={ 'amazon.com':'Amazon','wayfair.com':'Wayfair','target.com':'Target' };
      return map[host]||host;
    }
    function currency(n){
      const v = Number(n)||0; return `$${v.toFixed(2)}`;
    }
    function cleanUrl(raw){
      let u = (raw||'').trim();
      if(!u) return '';
      u = u.replace(/^\d+\)\s*/, '').replace(/^\(|\)$/g,'');   // strip "1) " and ( ... )
      if(!/^https?:\/\//i.test(u)){ u = `https://${u}`; }      // add protocol if missing
      try{
        const url = new URL(u);
        const host = url.hostname.replace(/^www\./,'');
        // unwrap common redirectors
        if(host === 'google.com' && url.pathname === '/url'){
          const target = url.searchParams.get('q') || url.searchParams.get('url');
          if(target) return cleanUrl(target);
        }
        if(host === 'l.facebook.com' || host === 'lm.facebook.com'){
          const target = url.searchParams.get('u');
          if(target) return cleanUrl(target);
        }
        if(host === 'r.mail.yahoo.com' || host === 'urldefense.proofpoint.com'){
          const target = url.searchParams.get('q') || url.searchParams.get('u');
          if(target) return cleanUrl(target);
        }
        ['utm_source','utm_medium','utm_campaign','utm_term','utm_content','fbclid','gclid','spm','_hsenc','_hsmi']
          .forEach(p=>url.searchParams.delete(p));
        return url.toString();
      }catch{ return u; }
    }

    // ====== Data building ======
    function buildItems(lines){
      let counts={};
      return lines.map(line => {
        const parts = line.split(',');
        const urlPartRaw = (parts[0]||'').trim();
        const urlPart = cleanUrl(urlPartRaw);
        const pricePart = (parts[1]||'').trim();
        const host = normalizeHost(urlPart);
        counts[host] = (counts[host]||0) + 1;
        return {
          url: urlPart,
          vendorHost: host,
          title: `${vendorLabel(host)} Item ${counts[host]}`, // fallback text
          name: 'Fetching name…',  // will be replaced by /meta result
          unitPrice: pricePart,
          _fetched: false
        };
      });
    }
    function groupByVendor(items){
      const groups={};
      items.forEach(it=>{
        const key=it.vendorHost;
        if(!groups[key]) groups[key]={key, label:vendorLabel(key), items:[], deliveryFee:''};
        groups[key].items.push(it);
      });
      return groups;
    }

    // ====== Fetch product names ======
    async function fetchTitleForItem(it, onUpdate){
      if(it._fetched || !it.url) return;
      it._fetched = true;
      try{
        const resp = await fetch(`${API_BASE}/meta?url=${encodeURIComponent(it.url)}`);
        const data = await resp.json();
        it.name = (data && data.name) ? data.name : '(Title unavailable)';
      }catch{
        it.name = '(Title unavailable)';
      }
      onUpdate(); // re-render to show the name
    }
    function kickoffTitleFetches(groups, onUpdate){
      Object.values(groups).forEach(grp=>{
        grp.items.forEach(it=> fetchTitleForItem(it, onUpdate));
      });
    }

    // ====== UI render ======
    function renderGroups(groups){
      const wrap=document.getElementById('groups');
      wrap.innerHTML='';
      let grand=0; let vendorCount=0; let itemCount=0;

      for(const [key,grp] of Object.entries(groups)){
        vendorCount++; itemCount+=grp.items.length;
        const vendorSubtotal = grp.items.reduce((s,it)=> s + (Number(it.unitPrice)||0), 0);
        const delivery = Number(grp.deliveryFee)||0;
        const vendorTotal = vendorSubtotal + delivery;
        grand += vendorTotal;

        const card=document.createElement('div');
        card.className='bg-white border rounded p-3';

        const itemsHtml = grp.items.map((it, idx)=>{
          const idPrice = `price-${key}-${idx}`;
          const idBtn = `btn-${key}-${idx}`;
          const idUrl = `url-${key}-${idx}`;
          const idName = `name-${key}-${idx}`;
          return `
            <div class="mb-3">
              <div class="text-sm text-gray-500">Vendor: ${grp.label}</div>
              <div class="font-medium" id="${idName}">${it.name || it.title}</div>
              <div class="text-xs text-gray-600 break-all" id="${idUrl}">${it.url}</div>
              <div class="mt-1 flex items-center gap-2">
                <input type="number" step="0.01" inputmode="decimal" class="num border rounded p-2 w-32" id="${idPrice}" placeholder="Price" value="${it.unitPrice||''}" />
                <a href="${it.url}" target="_blank" rel="noopener noreferrer" class="btn btn-ghost" id="${idBtn}">Get Price</a>
              </div>
            </div>`;
        }).join('');

        card.innerHTML = `
          <div class="font-semibold mb-2">${grp.label}</div>
          ${itemsHtml}
          <label class="block text-xs text-gray-700 mb-1">Delivery fee (optional) for ${grp.label}</label>
          <input type="number" step="0.01" inputmode="decimal" class="num border rounded p-2 w-28" placeholder="0.00" data-vendor="${key}" value="${grp.deliveryFee||''}" />
          <div class="mt-2 text-sm">Vendor subtotal: <strong>${currency(vendorSubtotal)}</strong></div>
          <div class="text-sm">Delivery fee: <strong>${currency(delivery)}</strong></div>
          <div class="text-sm">Vendor total: <strong>${currency(vendorTotal)}</strong></div>
        `;
        wrap.appendChild(card);

        // Listeners
        grp.items.forEach((it, idx)=>{
          const priceEl = card.querySelector(`#price-${key}-${idx}`);
          if(priceEl){
            priceEl.addEventListener('input', (e)=>{
              it.unitPrice = e.target.value;
              renderGroups(window.__GROUPS__); // keep totals live
            });
          }
        });

        const delEl = card.querySelector(`input[data-vendor="${key}"]`);
        if(delEl){
          delEl.addEventListener('input', (e)=>{
            groups[key].deliveryFee = e.target.value;
            renderGroups(window.__GROUPS__);
          });
        }
      }

      document.getElementById('totalsBadge').textContent=`${vendorCount} vendor(s), ${itemCount} item(s)`;
      document.getElementById('grandTotal').textContent=currency(grand);
    }

    // ====== Events ======
    document.getElementById('process').addEventListener('click',()=>{
      const lines=parseLines(document.getElementById('links').value);
      if(!lines.length) return;
      const items=buildItems(lines);
      window.__GROUPS__=groupByVendor(items);
      document.getElementById('groupsSection').classList.remove('hidden');

      // Initial render shows placeholders, then background fetch fills names
      renderGroups(window.__GROUPS__);
      kickoffTitleFetches(window.__GROUPS__, ()=> renderGroups(window.__GROUPS__));

      // focus first price input
      const first = document.querySelector('#groups input[type="number"]');
      if(first) first.focus();
    });

    document.getElementById('clearAll').addEventListener('click',()=>{
      document.getElementById('links').value='';
      document.getElementById('groups').innerHTML='';
      document.getElementById('groupsSection').classList.add('hidden');
      window.__GROUPS__ = {};
    });
  </script>
</body>
</html>
